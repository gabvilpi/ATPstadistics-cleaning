---
title: "PEC3 - Modelaci?n predictiva"
author: "Alejandro Manuel Olivares Luque"
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  html_document:
    toc: yes
    toc_depth: 4
  pdf_document:
    toc: yes
    toc_depth: 4
---

#PEC3 - Modelación predictiva

## Descripción del dataset. ?Por qu? es importante y qu? pregunta/problema pretende responder?
##Integración y selecci?n de los datos de inter?s a analizar.
Se realiza la carga de los datos. 
```{r chunck1}
library(readxl)
ATPstatistics <- read_excel("../Data/ATPstatistics.xlsx")
head(ATPstatistics)
```
Una vez que hemos realizado la carga correcta de los datos. A continuación, veremos el tipo de datos seleccionado por R para cada campo.
```{r chunck2}
str(ATPstatistics)
```
Como podemos observar, los tipos de datos que R ha seleccionado a cada variable no es el mejor, por lo quie procedemos a transformarlos a un tipo de datos más adecuado. 

```{r chunck3}
ATPstatistics$id_partido<-as.integer(ATPstatistics$id_partido)
ATPstatistics$`Player 1`<-as.factor(ATPstatistics$`Player 1`)
ATPstatistics$`Player 2`<-as.factor(ATPstatistics$`Player 2`)
ATPstatistics$`Serve Rating 1` <- as.integer(ATPstatistics$`Serve Rating 1`)
ATPstatistics$`Serve Rating 2` <- as.integer(ATPstatistics$`Serve Rating 2`)
ATPstatistics$`Aces 1`<- as.integer(ATPstatistics$`Aces 1`)
ATPstatistics$`Aces 2`<- as.integer(ATPstatistics$`Aces 2`)
ATPstatistics$`Double Faults 1` <- as.integer(ATPstatistics$`Double Faults 1`)
ATPstatistics$`Double Faults 2` <- as.integer(ATPstatistics$`Double Faults 2`)
ATPstatistics$`Served Games Played 1` <- as.integer(ATPstatistics$`Served Games Played 1`)
ATPstatistics$`Served Games Played 2` <- as.integer(ATPstatistics$`Served Games Played 2`)
ATPstatistics$`Return Rating 1` <- as.integer(ATPstatistics$`Return Rating 1`)
ATPstatistics$`Return Rating 2` <- as.integer(ATPstatistics$`Return Rating 2`)
ATPstatistics$`Return Games Played 1` <- as.integer(ATPstatistics$`Return Games Played 1`)
ATPstatistics$`Return Games Played 2` <- as.integer(ATPstatistics$`Return Games Played 2`)
ATPstatistics$Winner <- as.factor(ATPstatistics$Winner)
ATPstatistics$Tournament <- as.factor(ATPstatistics$Tournament)
ATPstatistics$`Started date` <- as.Date(as.character(ATPstatistics$`Started date`), "%d/%m/%Y")
ATPstatistics$`Ended date` <- as.Date(as.character(ATPstatistics$`Ended date`),  "%d/%m/%Y")
ATPstatistics$Surface <- as.factor(ATPstatistics$Surface)
ATPstatistics$`% 1st Serve 1` <- as.double(ATPstatistics$`% 1st Serve 1`)/100
ATPstatistics$`% 1st Serve 2` <- as.double(ATPstatistics$`% 1st Serve 2`)/100
ATPstatistics$`% 1st Serve Won 1` <-as.double(ATPstatistics$`% 1st Serve Won 1`)/100
ATPstatistics$`% 1st Serve Won 2` <-as.double(ATPstatistics$`% 1st Serve Won 2`)/100
ATPstatistics$`% 2nd Serve Won 1` <-as.double(ATPstatistics$`% 2nd Serve Won 1`)/100
ATPstatistics$`% 2nd Serve Won 2` <-as.double(ATPstatistics$`% 2nd Serve Won 2`)/100
ATPstatistics$`% Break Point Saved 1` <- as.double(ATPstatistics$`% Break Point Saved 1`)/100
ATPstatistics$`% Break Point Saved 2` <- as.double(ATPstatistics$`% Break Point Saved 2`)/100
ATPstatistics$`% Served Point Won 1` <- as.double(ATPstatistics$`% Served Point Won 1`)/100
ATPstatistics$`% Served Point Won 2` <- as.double(ATPstatistics$`% Served Point Won 2`)/100
ATPstatistics$`% Return Point Won 1` <- as.double(ATPstatistics$`% Return Point Won 1`)/100
ATPstatistics$`% Return Point Won 2` <- as.double(ATPstatistics$`% Return Point Won 2`)/100
ATPstatistics$`% Total Point Won 1` <- as.double(ATPstatistics$`% Total Point Won 1`)/100
ATPstatistics$`% Total Point Won 2` <- as.double(ATPstatistics$`% Total Point Won 2`)/100
ATPstatistics$`% 1st Serve Return Won 1` <- as.double(ATPstatistics$`% 1st Serve Return Won 1`)/100
ATPstatistics$`% 1st Serve Return Won 2` <- as.double(ATPstatistics$`% 1st Serve Return Won 2` )/100
ATPstatistics$`% 2nd Serve Return Won 1`<- as.double(ATPstatistics$`% 2nd Serve Return Won 1`)/100
ATPstatistics$`% 2nd Serve Return Won 2`<- as.double(ATPstatistics$`% 2nd Serve Return Won 2`)/100
ATPstatistics$`% Break Point Converted 1`<- as.double(ATPstatistics$`% Break Point Converted 1`)/100
ATPstatistics$`% Break Point Converted 2`<- as.double(ATPstatistics$`% Break Point Converted 2`)/100
str(ATPstatistics)
```

##Limpieza de los datos.

###¿Los datos contienen ceros o elementos vacíos? ¿Cómo gestionarías cada uno de estos casos?
```{r chunck5}
summary(ATPstatistics)
```
Existen observaciones con datos a cero, lo que denota que dichas observaciones no se han recogido datos para el partido. Los eliminamos a continuación.
```{r chunck6}
ATPstatistics<- ATPstatistics[which(ATPstatistics$`Serve Rating 1`!=0 & ATPstatistics$`Serve Rating 2`!=0 & ATPstatistics$`Return Rating 1` !=0 & ATPstatistics$`Return Rating 2` !=0),]
```
### Identificación y tratamiento de valores extremos.
Para identificar los valores extrremos realizaremos unos diagramas de cajas. En el caso de tener valores fuera de la normalidad, se representarán con un circulo.
```{r chunck8}
boxplot(ATPstatistics$`Serve Rating 1`,notch=TRUE, main= ("Serve Rating player 1"))
boxplot(ATPstatistics$`Serve Rating 2`,notch=TRUE, main= ("Serve Rating player 2"))
boxplot(ATPstatistics$`Aces 1`,notch=TRUE, main= ("Aces player 1"))
boxplot(ATPstatistics$`Aces 2`,notch=TRUE, main= ("Aces player 2"))
boxplot(ATPstatistics$`Double Faults 1`,notch=TRUE, main= ("Double Faults player 1"))
boxplot(ATPstatistics$`Double Faults 2`,notch=TRUE, main= ("Double Faults player 2"))
boxplot(ATPstatistics$`Return Rating 1`,notch=TRUE, main= ("Return rating player 1"))
boxplot(ATPstatistics$`Return Rating 2`,notch=TRUE, main= ("Return rating player 2"))
boxplot(ATPstatistics$`% 1st Serve 1`,notch=TRUE, main= ("% 1st Serve player 1"))
boxplot(ATPstatistics$`% 1st Serve 2`,notch=TRUE, main= ("% 1st Serve player 2"))
boxplot(ATPstatistics$`% 1st Serve Won 1`,notch=TRUE, main= ("% 1st Serve Won player 1"))
boxplot(ATPstatistics$`% 1st Serve Won 2`,notch=TRUE, main= ("% 1st Serve Won player 2"))
boxplot(ATPstatistics$`% 2nd Serve Won 1`,notch=TRUE, main= ("% 2nd Serve Won player 1"))
boxplot(ATPstatistics$`% 2nd Serve Won 2`,notch=TRUE, main= ("% 2nd Serve Won player 2"))
boxplot(ATPstatistics$`% Break Point Saved 1`,notch=TRUE, main= ("% Break point saved player 1"))
boxplot(ATPstatistics$`% Break Point Saved 2`,notch=TRUE, main= ("% Break poiint saved player 2"))
boxplot(ATPstatistics$`% 1st Serve Return Won 1`,notch=TRUE, main= ("% 1st Serve Return Won player 1"))
boxplot(ATPstatistics$`% 1st Serve Return Won 2`,notch=TRUE, main= ("% 1st Serve Return Won player 2"))
boxplot(ATPstatistics$`% 2nd Serve Return Won 1`,notch=TRUE, main= ("% 2nd Serve Return Won player 1"))
boxplot(ATPstatistics$`% 2nd Serve Return Won 2`,notch=TRUE, main= ("% 2nd Serve Return Won player 2"))
boxplot(ATPstatistics$`% Served Point Won 1`,notch=TRUE, main= ("% Served Point Won player 1"))
boxplot(ATPstatistics$`% Served Point Won 2`,notch=TRUE, main= ("% Served Point Won player 2"))
boxplot(ATPstatistics$`% Return Point Won 1`,notch=TRUE, main= ("% Return Point Won player 1"))
boxplot(ATPstatistics$`% Return Point Won 2`,notch=TRUE, main= ("% Return Point Won player 2"))
boxplot(ATPstatistics$`% Total Point Won 1`,notch=TRUE, main= ("Total Point Won player 1"))
boxplot(ATPstatistics$`% Total Point Won 2`,notch=TRUE, main= ("Total Point Won player 2"))
```
Existen bastantes valores extremos. Estos valores son normales, ya que por un lado, confiamos en la fuente de datos (ya que es una fuenta oficial) y por otro lado, es normal que haya jugadores que se salgan de lo normal, no hace falta irse muy lejos para saber que hay jugadores que tienen unas estadisticas que marcan una historia, ya sea Roger Federer o el español Rafael Nadal.
## Análisis de los datos.
###Selección de los grupos de datos que se quieren analizar/comparar(planificación de los análisis a aplicar).
Quitaremos el número total de juegos al servicio y al resto, ya que a priori, no nos aporta información relativa al juego de cada jugador. 
```{r chunck4}
ATPstatistics<-ATPstatistics[-c(18:19)]
ATPstatistics<-ATPstatistics[-c(26:27)]
```
### Comprobación de la normalidad y homogeneidad de la varianza.
Realizamos un test de normalidad y homogeneidad a los datos 
```{r chunck9}
'
#NO FUNCIONA
library(nortest)
atributos_no_normales = c()
for(i in 4:(ncol(ATPstatistics)-5)){
  atributos_no_normales = c(atributos_no_normales,colnames(ATPstatistics[ad.test(as.matrix(ATPstatistics[,i]))$p.value < 0.05]))
}
'

#Añadir homogeneidad
```

### Aplicación de pruebas estadísticas para comparar los grupos de datos. En funci?n de los datos y el objetivo del estudio, aplicar pruebas de contrastede hipótesis, correlaciones, regresiones, etc.
```{r chunck11}

```

## Representación de los resultados a partir de tablas y gráficas.
```{r chunck12}

```

##Resolución del problema. A partir de los resultados obtenidos, ?cu?les son las conclusiones? ?Los resultados permiten responder al problema?
Para poder responder a la pregunta que nos planteabamos al inicio, dado que los datos no están del todo preparados, ya que tenemos las estadisticas reales de los partidos. Necesitamos obtener las estimaciones de los partidos, para ello, realizaremos la media y varianza de las estadisticas de los últimos partidos de cada jugador.
```{r chunck7}
require(data.table)
partidos = 5
dataset <- matrix(nrow=0,ncol=63)
variablesj1 <- c(1,seq(4,31,by = 2))
variablesj2 <- c(1,seq(5,32,by = 2))
otras_variables <- seq(33,ncol(ATPstatistics),by = 1)
jugador1<-as.character(ATPstatistics$`Player 1`)
jugador2<-as.character(ATPstatistics$`Player 2`)
for(i in 1:nrow(ATPstatistics)){
  resultado <- matrix(nrow=0,ncol=63)
  estadisticas_jugador1_1 <-ATPstatistics[which(ATPstatistics$`Player 1`==jugador1[i]),variablesj1]
  estadisticas_jugador1_2 <-ATPstatistics[which(ATPstatistics$`Player 2`==jugador1[i]),variablesj2]
  estadisticas_jugador2_1 <-ATPstatistics[which(ATPstatistics$`Player 1`==jugador2[i]),variablesj1]
  estadisticas_jugador2_2 <-ATPstatistics[which(ATPstatistics$`Player 2`==jugador2[i]),variablesj2] 
  estadisticas_jugador1 <- rbind(as.matrix(estadisticas_jugador1_1),as.matrix(estadisticas_jugador1_2))
  estadisticas_jugador2 <- rbind(as.matrix(estadisticas_jugador2_2),as.matrix(estadisticas_jugador2_1))
  estadisticas_jugador1<-data.table(estadisticas_jugador1,key="id_partido")
  estadisticas_jugador2<-data.table(estadisticas_jugador2,key="id_partido")
  estadisticas_jugador1 <- estadisticas_jugador1[(which(estadisticas_jugador2$id_partido >ATPstatistics$id_partido[i])),2:ncol(estadisticas_jugador1)]
  estadisticas_jugador2 <- estadisticas_jugador2[(which(estadisticas_jugador2$id_partido > ATPstatistics$id_partido[i])),2:ncol(estadisticas_jugador2)]
  if(nrow(estadisticas_jugador1)>= partidos & nrow(estadisticas_jugador2)>= partidos){
    estadisticas_jugador1 <- estadisticas_jugador1[1:partidos,]
    estadisticas_jugador2 <- estadisticas_jugador2[1:partidos,]
    estadisticas_jugador1 <- cbind(t(colMeans(estadisticas_jugador1)),t(apply(estadisticas_jugador1,2,sd)))
    estadisticas_jugador2 <- cbind(t(colMeans(estadisticas_jugador2)),t(apply(estadisticas_jugador2,2,sd)))
    if(i%%2 == 1){
      if(ATPstatistics$Winner[i]==jugador1[i])
        ganador = 1
      else
        ganador = 2
      resultado <- cbind(ATPstatistics$id_partido[i],jugador1[i],jugador2[i],estadisticas_jugador1,estadisticas_jugador2,ganador,ATPstatistics[i,otras_variables])
    }
    else{
      if(ATPstatistics$Winner[i]==jugador1[i])
        ganador = 2
      else
        ganador = 1
      resultado <- cbind(ATPstatistics$id_partido[i],jugador2[i],jugador1[i],estadisticas_jugador2,estadisticas_jugador1,ganador,ATPstatistics[i,otras_variables])
    }
    if(i == 1)
      dataset<-resultado
    elsea<
      dataset <- rbind(as.matrix(dataset),as.matrix(resultado))
  }
}
#write.csv(dataset, "./Data/dataset.csv")
```
Una vez tenemos generado el dataset, procedemos a realizar un kfold de 10 y procedemos a entrenar los diferentes modelos.
```{r chunck10}


```
Como podemos ver en en los resultados de los diferentes modelos obtenemos un acierto de X en test, por lo que afirmamos que con los datos que hemos obtenido podemos realizar predicciones de los partidos futuros. 